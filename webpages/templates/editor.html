<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>文章编写</title>
    <link rel="stylesheet" href="../css/bootstrap.min.css">
    <link rel="stylesheet" href="../css/github-markdown.css">
    <link rel="stylesheet" href="../css/m.common.css">
</head>
<body class="position-absolute w-100">
<div class="m-auto clearfix" style="width: 98%;">
    <div class="col-lg-6 float-lg-left">
        <div class="form-group row border p-1 mb-0">
            <div class="col-sm-2 col-form-label ">文章标题：</div>
            <input type="text" class="col-sm-10 form-control border-primary" id="_editor-article-title"
                   placeholder="文章标题">
        </div>
    </div>
    <div class="col-lg-6 float-lg-left">
        <div class="form-group row border p-1 mb-0">
            <div class="col-sm-2 col-form-label ">分类标签：</div>
            <div class="col-sm-10 form-control border-secondary align-middle pl-0" id="_editor-classify-labs-area">
                <div class="d-inline-block btn-group">
                    <div class="dropdown-toggle btn btn-default  p-0 text-left" data-toggle="dropdown">
                        <span class="caret">标签</span>
                    </div>
                    <div class="dropdown-menu">
                        <a class="dropdown-item btn">标题样式</a>
                        <a class="dropdown-item btn">段落样式</a>
                        <a class="dropdown-item btn">列表样式</a>
                        <a class="dropdown-item btn">区块样式</a>
                    </div>
                </div>

                <div class="d-inline-block ml-2" id="_editor-classify-labs">

                </div>
                <div class="d-inline-block btn float-right clearfix p-0" title="添加一个标签"
                     onclick="showInput('#_editor-classify-labs')">+
                </div>
            </div>

        </div>
    </div>
    <div class="col-lg-6 float-lg-left">
        <div class="form-group row border p-1 mb-0">
            <div class="col-sm-2 col-form-label ">文章标签：</div>
            <div class="col-sm-10 form-control border-secondary align-middle pl-0" id="_editor-article-labs-area">
                <div class="d-inline-block btn-group">
                    <div class="dropdown-toggle btn btn-default  p-0 text-left" data-toggle="dropdown">
                        <span class="caret">标签</span>
                    </div>
                    <div class="dropdown-menu">
                        <a class="dropdown-item btn">标题样式</a>
                        <a class="dropdown-item btn">段落样式</a>
                        <a class="dropdown-item btn">列表样式</a>
                        <a class="dropdown-item btn">区块样式</a>
                    </div>
                </div>

                <div class="d-inline-block ml-2" id="_editor-article-labs">

                </div>
                <div class="d-inline-block btn float-right clearfix p-0" title="添加一个标签"
                     onclick="showInput('#_editor-article-labs')">+
                </div>
            </div>

        </div>
    </div>
    <div class="col-lg-6 float-lg-right clearfix">
        <div class="form-group row border p-1 mb-0">
            <div class="col-sm-2 col-form-label ">文章类型：</div>
            <div class="col-sm-3 form-control border-0" id="_editor-article-type">
                <div class="radio d-inline-block">
                    <label>
                        <input type="radio" name="optionsRadios" value="blog" checked>博客
                    </label>
                </div>
                <div class="radio d-inline-block ml-3">
                    <label>
                        <input type="radio" name="optionsRadios" value="note">笔记
                    </label>
                </div>
            </div>
            <div class="col-sm-3 col-form-label ">是否为原创：</div>
            <div class="col-sm-3 form-control border-0" id="_editor-article-origin">
                <div class="radio d-inline-block">
                    <label>
                        <input type="radio" name="optionsRadios1" value="yes" checked>原创
                    </label>
                </div>
                <div class="radio d-inline-block ml-3">
                    <label>
                        <input type="radio" name="optionsRadios1" value="no">非原创
                    </label>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-12 float-lg-right clearfix">
        <div class="form-group row border p-1 mb-0">
            <div class="col-sm-12 col-form-label">文章摘要：</div>
            <textarea class="col-sm-12 form-control border-secondary" rows="3" id="_editor-article-summary">
            </textarea>
        </div>
    </div>
</div>
<div class="m-auto" style="width: 98%;">
    <div class="position-relative w-100 mt-1 mb-1" style="height: 700px">
        <div class="w-50 h-100 float-left m-auto border">
            <div class="h-100 w-100 p-2 bg-white overflow-auto markdown-body" id="_markdown_show_area"></div>
        </div>
        <div class="w-50 h-100 float-right m-auto border">
            <textarea class="h-100 w-100 p-2" id="_markdown-editable-area" autofocus>
        </textarea>
            <div class="dropright " style="position: absolute;top: 30%;">
                <div class="dropright" style="margin-left: -50%">
                    <button class="p-0 dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"
                            aria-expanded="false">
                    </button>
                    <div class="dropdown-menu">
                        <a class="dropdown-item disabled" href="#">标题样式</a>
                        <a class="dropdown-item disabled" href="#">段落样式</a>
                        <a class="dropdown-item disabled" href="#">列表样式</a>
                        <a class="dropdown-item disabled" href="#">区块样式</a>
                        <a class="dropdown-item disabled" href="#">代码样式</a>
                        <a class="dropdown-item disabled" href="#">链接样式</a>
                        <a class="dropdown-item" href="#">图片插入</a>
                        <a class="dropdown-item disabled" href="#">表格样式</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="m-auto" style="width: 98%;">
    <div class="btn w-100 bg-primary mt-1 mb-2" onclick="submit()">提交</div>
</div>
<div class="modal fade" id="_submit-msg-show" data-backdrop="static" data-keyboard="false" tabindex="-1"
     aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="staticBackdropLabel">即将提交的信息</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="_commit-modal">

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="confirm()">确认提交</button>
            </div>
        </div>
    </div>
</div>

<script type="application/javascript" src="../js/jquery-3.5.1.min.js"></script>
<script type="application/javascript" src="../js/showdown.min.js"></script>
<script type="application/javascript" src="../js/bootstrap.bundle.min.js"></script>
<script type="application/javascript" src="../js/bootstrap.min.js"></script>
<script type="application/javascript" src="../js/m.common.js"></script>
<script>
    let editorUrl = "/admin/addArticle";
    $(function () {
        $("#_markdown_show_area").html(converter.makeHtml($(this).val()));
        $("#_markdown-editable-area").bind('change', function () {
            $("#_markdown_show_area").html(converter.makeHtml($(this).val()));
        });
        $("#_markdown-editable-area").bind('blur', function () {
            $("#_markdown_show_area").html(converter.makeHtml($(this).val()));
        });

    });

    function closeLab(selector) {
        $($(selector).parent('div')).remove();
    }

    function showInput(selector) {
        $(selector).append("<input class='_temp-input' autofocus onblur='inputBlur(this)'>")
    }

    function inputBlur(selector) {
        let data = $(selector).val();
        let parent = $(selector).parent();
        if (data && data.toString().replace(' ', '')) {
            addLab(parent, data)
            $(selector).remove();
        }
    }

    function addLab(selector, name) {
        let labs = $(selector).find('span._lab-name');
        for (let i = 0; i < labs.length; i++) {
            console.log($(labs[i]).text());
            if (name == $(labs[i]).text()) return;
        }
        $(selector).append('<div class="d-inline-block border bg-gray-light pl-1 ml-1">\n' +
            '                        <span class="pr-1 _lab-name">' + name + '</span>\n' +
            '                        <button type="button" class="close d-inline-block " aria-label="Close" onclick="closeLab(this)">\n' +
            '                            <span aria-hidden="true">&times;</span>\n' +
            '                        </button>\n' +
            '                    </div>');
    }

    function submit() {
        let title = $("#_editor-article-title").val();
        let summary = $("#_editor-article-summary").val();
        let type = $("#_editor-article-type input:checked").val();
        let ifOrigin = $("#_editor-article-origin input:checked").val();
        let classifyList = $("#_editor-classify-labs").find("span._lab-name");
        let articleList = $("#_editor-article-labs").find("span._lab-name");
        let classifyLabs = "";
        let articleLabs = "";
        for (let i = 0; i < classifyList.length; i++) {
            classifyLabs += "|" + $(classifyList[i]).text();
        }
        for (let i = 0; i < articleList.length; i++) {
            articleLabs += "|" + $(classifyList[i]).text();
        }
        $("#_commit-modal").html(' <div>文章标题：\n' +
            '                    <textarea class="w-100" rows="3" readonly>' + title + '</textarea>\n' +
            '                </div>\n' +
            '\n' +
            '                <div>文章简介：\n' +
            '                    <textarea class="w-100" rows="3" readonly>' + summary + '</textarea>\n' +
            '                </div>\n' +
            '                <div>文章类型：<span class="">' + type + '</span></div>\n' +
            '                <div>是否原创：<span class="">' + ifOrigin + '</span></div>\n' +
            '                <div>文章分类：<span class="">' + classifyLabs + '</span></div>\n' +
            '                <div>文章标签：<span class="">' + articleLabs + '</span></div>\n');
        $("#_submit-msg-show").modal('show');
    }

    function confirm() {
        let title = $("#_editor-article-title").val();
        let summary = $("#_editor-article-summary").val();
        let type = $("#_editor-article-type input:checked").val();
        let original = $("#_editor-article-origin input:checked").val();
        let classifyList = $("#_editor-classify-labs").find("span._lab-name");
        let articleList = $("#_editor-article-labs").find("span._lab-name");
        let classifyLabs = "";
        let articleLabs = "";
        for (let i = 0; i < classifyList.length; i++) {
            classifyLabs += $(classifyList[i]).text() + "\n";
        }
        for (let i = 0; i < articleList.length; i++) {
            articleLabs += $(classifyList[i]).text() + "\n";
        }
        let content = $("#_markdown-editable-area").val();
        let data = {
            "title": title,
            "summary": summary,
            "type": type,
            "original": original,
            "classifyLabs": classifyLabs,
            "articleLabs": articleLabs,
            "content": content
        };
        $("#_submit-msg-show").modal('hide');
        $.post(editorUrl, data, function (data, status) {
            debugger;
            if (status == 'success') {
                if (data['result'] == 'success') {
                    alert("提交文章成功");
                } else {
                    alert("提交文章失败，" + data['msg']);
                }
            } else {
                alert("请求失败");
            }
        })
    }
</script>
</body>
</html>